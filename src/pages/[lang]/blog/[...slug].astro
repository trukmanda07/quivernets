---
import { type CollectionEntry, render } from 'astro:content';
import BlogPost from '../../../layouts/BlogPost.astro';
import { supportedLanguages } from '../../../utils/i18n';
import { buildExplorerTree } from '../../../utils/explorerTree';
import { BlogPostService } from '../../../services/BlogPostService';

export async function getStaticPaths() {
	const paths = [];

	for (const lang of supportedLanguages) {
		const posts = await BlogPostService.getAll(lang as 'en' | 'id');

		if (posts.length === 0) {
			console.warn(`Collection blog-${lang} is empty or doesn't exist yet`);
			continue;
		}

		for (const post of posts) {
			paths.push({
				params: { lang, slug: post.id },
				props: { post, lang },
			});
		}
	}

	return paths;
}

type Props = {
	post: CollectionEntry<'blog-en'> | CollectionEntry<'blog-id'>;
	lang: string;
};

const { post, lang } = Astro.props;
const { Content, headings } = await render(post);

// Build explorer tree for sidebar (using service)
const allPosts = await BlogPostService.getAll(lang as 'en' | 'id');
const explorerTree = buildExplorerTree(allPosts, lang);

// Transform Astro headings to our Heading format for the Topics sidebar
import { buildHeadingTree } from '../../../utils/headingExtractor';
import type { FlatHeading } from '../../../utils/headingExtractor';

const flatHeadings: FlatHeading[] = headings.map(h => ({
	id: h.slug,
	text: h.text,
	level: h.depth
}));

const headingTree = buildHeadingTree(flatHeadings);
---

<BlogPost
	{...post.data}
	postId={post.id}
	language={lang}
	explorerTree={explorerTree}
	currentSlug={post.id}
	headings={headingTree}
>
	<Content />
</BlogPost>
